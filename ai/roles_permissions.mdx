# Convex Bitwise Roles & Permissions System

This document outlines the architecture of Echoray's Discord-inspired permission system, fully migrated to Convex.

## 1. System Overview

A multi-tenant SaaS permission system featuring:
- **Subscription Tiers**: user (free), web (€99), app (€299), crm (custom)
- **Organizations**: Users create and manage teams.
- **Roles**: Hierarchical roles per organization with bitwise permission integers.
- **Permissions**: Granular, system-wide definitions using bitwise positions (0-63).
- **Addons**: Feature-specific flags purchased per organization.
- **Member Overrides**: Precise permission grants or denies per member.

### Permission Resolution Order (Top-Down)
1. **Explicit DENY override** → ❌ DENY
2. **Explicit ALLOW override** → ✅ ALLOW  
3. **Organization purchased addons** → ✅ ALLOW
4. **Member's combined roles** → ✅ ALLOW if any role has the bit set
5. **Organization subscription tier** → ✅ ALLOW if tier includes the bit
6. **System role privileges** (Owner/Admin) → ✅ ALLOW for management tasks
7. **Default** → ❌ DENY

---

## 2. Data Model (Convex Schema)

Located in `convex/schema.ts`.

### Key Tables
- **`subscriptionTiers`**: Defines base permissions and limits for each plan.
- **`organizations`**: Stores tenant data, tier info, and owner.
- **`organizationMembers`**: Links users to orgs with status and computed permission cache.
- **`permissions`**: System-wide registry of all possible actions and their bit positions.
- **`roles`**: Custom role definitions (name, color, bitwise permissions) per org.
- **`memberRoles`**: Many-to-many link between members and roles.
- **`memberPermissionOverrides`**: Manual overrides for specific members.

---

## 3. Bitwise Logic

### Mapping
Each permission is assigned a `bitPosition` from 0 to 63.
- `profile.view` (Bit 0) = `1`
- `profile.edit` (Bit 1) = `2`
- `analytics.view` (Bit 2) = `4`
- ...and so on.

### Computation in Convex
Instead of SQL functions or triggers, we use TypeScript utility functions. Since Convex doesn't have traditional database triggers, permission recalculation is handled within the mutations that modify roles or memberships.

> [!IMPORTANT]
> **JavaScript Number Precision**: JavaScript's `number` type is a 64-bit float, which safely represents integers up to `2^53 - 1` (`Number.MAX_SAFE_INTEGER`). This allows for up to 53 permission bits. If more are needed, the system must switch to `v.string()` or `BigInt`.

### No Database Triggers
In Supabase/PostgreSQL, we used `AFTER INSERT` triggers. In Convex:
1. **Organization Creation**: The `createOrganization` mutation explicitly calls `createSystemRoles` and initializes the owner's membership.
2. **Permission Caching**: The `computedPermissions` field in `organizationMembers` should be updated by any mutation that changes a user's roles or the organization's tier.

---

## 4. Permission Resolution Function

Effective permissions are calculated in the `api.permissions.getUserPermissions` query:

1. Fetch **Tier Permissions** from `subscriptionTiers`.
2. Fetch **Addon Permissions** from `organizationAddons`.
3. Fetch **Role Permissions** by OR-ing all `roles` associated with the member.
4. Apply **Overrides** (allowing specific bits or stripping them).
5. Resulting integer is returned to the frontend and cached in the store.

---

## 5. Security & Access Control

### Query/Mutation Guards
Every mutation must verify the caller's permissions:

```typescript
// convex/organizations.ts
export const updateOrganization = mutation({
  handler: async (ctx, args) => {
    const permissions = await getEffectivePermissions(ctx, args.orgId);
    if (!hasPermission(permissions, PERMISSION_BITS['org.settings'])) {
      throw new Error("Unauthorized");
    }
    // ... logic
  }
});
```

---

## 6. Seeding the System

Initial system data is populated via `convex/seed.ts`. Use `npx convex run seed:seedData` to initialize:
- System permissions (0-21)
- Standard subscription tiers (User, Web, App, CRM)

---

## 7. Frontend Integration

### `usePermissions()` Hook
Located in `src/hooks/use-permissions.ts`. Provides a reactive way to check permissions:

```tsx
const { can } = usePermissions();
if (can('analytics.view')) {
  return <AnalyticsDashboard />;
}
```

### `<PermissionGuard />` Component
Wraps UI elements to conditionally render them based on permissions.