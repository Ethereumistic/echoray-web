# Convex Authentication System Architecture

This document provides a comprehensive analysis of the Echoray authentication system using Convex Auth, covering implementation details, session management, and integrated profile sync.

## 1. Authentication Flow Overview

The system uses **Convex Auth** (@convex-dev/auth) for end-to-end authentication, leveraging Convex's built-in session management and reactive data layer.

### Routes Organization
- **Public Routes (`/`, `/services`, etc.)**: Accessible without authentication.
- **Auth Routes (`/auth/*`)**: For login, signup, and recovery flows.
- **Protected Routes (`/dashboard/*`)**: Enforced via `middleware.ts` using `convexAuthNextjsMiddleware`.

---

## 2. Technical Stack & Best Practices

### Convex Auth Integration
- ✅ **First-Class Integration**: Uses `@convex-dev/auth/server` for edge-compatible session handling and server-side redirects.
- ✅ **Route Protection**: Implemented at the Edge/Middleware level, preventing unauthorized access before the page even begins to render.
- ✅ **Unified Data Layer**: Auth data lives directly in the Convex database (`users`, `sessions`, `accounts` tables), making it reactive and easy to join with application data.
- ✅ **Secure Sessions**: Convex Auth manages sessions securely via signed cookies handled by the `ConvexAuthNextjsServerProvider`.

### Password Security
- ✅ **Standard Hashing**: Passwords are secure hashed and stored in the `users` table via the `Password` provider.
- ✅ **Validation**: Zod-based validation in the frontend ensures password complexity and length constraints (see `src/lib/validations.ts`).

---

## 3. Session & State Management

### Middleware (Server-Side)
The `src/middleware.ts` uses `convexAuthNextjsMiddleware`. This:
1.  **Verifies JWT**: Checks the session cookie validity on every request.
2.  **Redirects**: Automatically sends unauthenticated users from `/dashboard` or `/o/[slug]` to `/auth/login`.
3.  **Auth Store Access**: Provides an `isAuthenticated()` check to determining access during the request.

### Auth Store (Zustand)
The `useAuthStore` (`src/stores/auth-store.ts`) acts as the client-side source of truth:
1.  **Profile Persistence**: Caches the user profile to allow for instant UI rendering.
2.  **Reactive Updates**: Updated by `OrgInitializer` when Convex data changes.
3.  **Cross-Component Access**: Provides easy access to `userId`, `activeOrganization`, and `permissions` throughout the React tree.

---

## 4. Key Auth Flows

### Sign Up / Sign In
- **Location**: `src/components/auth/sign-up-form.tsx` and `login-form.tsx`
- **Hook**: `useAuthActions()` from `@convex-dev/auth/react`
- **Method**: `signIn("password", { email, password, flow: "signUp" | "signIn" })`

### Session Lifecycle
- **persistent**: Sessions remain valid across browser restarts via cookie persistence.
- **Sign Out**: `signOut()` from `useAuthActions()` clears the session both on the client and in the Convex database.

---

## 5. Unified Profile Management

Exhoray uses a unified approach where profile data lives directly on the `users` table, rather than a separate `profiles` table. This reduces query latency and simplifies data fetching.

### Profile Structure
- **`name`**: User's full display name.
- **`image`**: Avatar URL.
- **`username`**: Unique handle for mentions/profile.
- **`email`**: Primary contact email (verified by auth).

### Initialization
When a user signs in, the `OrgInitializer` component:
1.  Fetches the unified user document from the `users` table.
2.  Fetches their associated organizations.
3.  Calculates permissions for the active organization.
4.  Hydrates the Zustand store.

---

## 6. Recommendations & Maintenance

1.  **OAuth Expansion**: Easily add Google/GitHub providers via `auth.ts` config.
2.  **Role Changes**: When user roles change in `members.ts`, the frontend reacts instantly due to Convex's subscription model.
3.  **Security Audit**: Periodically check `convex/auth.ts` for provider configurations and password constraints.
